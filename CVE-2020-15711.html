<!DOCTYPE html>
<html lang="en-us">
<head>
	<title>Advisory: CVE-2020-15711</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="description" content="Advisory regarding CVE-2020-15711" />
	<meta name="author" content="Mislav Bozicevic" />
	<style>
* {
	font-size: 14px;
	font-family: Verdana, sans-serif;
	color: black;
	background-color: white;
}

img {
	background-size: cover;
	top: 0;
	left: 3rem;
	bottom: 0;
	padding: 0;
	width: calc(100% - 3rem);
}

main {
	padding: 1rem 1.5rem;
	max-width: 85em;
	margin-left: auto;
	margin-right: auto;
}

section {
	border-bottom: 1px solid rgba(0,0,0,0.1);
	padding: 1.3rem 0;
	margin-bottom: 1.3rem;
}

section:last-child {
	border: none;
	padding-bottom: 0;
}

section:first-child {
	border: none;
	padding-top: 0;
}

ol > li {
	padding: 1.3rem 0;
}
	</style>
</head>

<body>
	<main>
		<header>
			<h2>Advisory: CVE-2020-15711</h2>
		</header>
		<section>
			<h3>Affected Vendors</h3>
			<p><a href="https://www.misp-project.org/">MISP project</a></p>
		</section>
		<section>
			<h3>Issues</h3>
			<p>Improper input validation in <i>UserSettingsController.php</i> for the
			<i>path</i> argument in function
<i><a href="https://github.com/MISP/MISP/blob/f278407e915ff7f6e2e40bc1035206c8be2a1581/app/Controller/UserSettingsController.php#L326">setHomePage</a></i>.
			Missing anti-CSRF token for the mentioned controller action.</p>
		</section>
		<section>
			<h3>Description</h3>
			<p><i>misp.js</i> contains function
<i><a href="https://github.com/MISP/MISP/blob/f278407e915ff7f6e2e40bc1035206c8be2a1581/app/webroot/js/misp.js#L5028">setHomePage</a></i>
			which issues a POST request to
			<i>baseurl + '/userSettings/setHomePage'</i> API endpoint with parameter
			<i>path</i> (currently <i>window.location.pathname</i>).
			See screenshot [<a href="#1">1</a>] for the
			resulting HTTP request and response. The <i>path</i> parameter is
			stored without validation (see <i>UserSettingsController.php</i>). After page
			refresh, the <i>path</i> parameter is prepended with <i>baseurl</i> and reflected
			to the victim (authenticated user) as shown in screenshot [<a href="#2">2</a>] (<i>Home</i>).
			For the mentioned API endpoint, there is no anti-CSRF token protection
			allowing an attack scenario as described in the next section.</p>
		</section>
		<section>
			<h3>Attack Preconditions and Example Scenario</h3>
			<p>To exploit this vulnerability, the victim needs to be logged into the
			application and in another tab visit the attacker-controlled page.
			Attacker-controlled <abbr title="Proof of Concept">PoC</abbr>
			page for exploitation is shown in screenshot [<a href="#3">3</a>].
			To successfully perform CSRF with the intended effect, the attacker
			needs to know <i>baseurl</i> parameter (i.e. the hostname or IP address of
			the machine hosting the application), so that they could register a
			subdomain where to receive the lured victim. The victim navigates
			to the attacker-set URL when <i>Home</i> action is performed (screenshot [<a href="#2">2</a>]).</p>
		</section>
		<section>
			<h3>Impact</h3>
			<p>Exploiting the vulnerability allows the attacker to lure the victim to an
			attacker-controlled server, according to the limitations as imposed by
			the <i>baseurl</i> parameter.</p>
		</section>
		<section>
			<h3>Affected Versions</h3>
			<p>Discovered on <a href="https://github.com/MISP/MISP/tree/v2.4.125">v2.4.125</a>.
			Affects versions <a href="https://cve.circl.lu/cve/CVE-2020-15711">before v2.4.129</a>.</p>
		</section>
		<section>
			<h3>Recommendation</h3>
			<p>Update to the version which contains vendor's patch
			(<a href="https://github.com/MISP/MISP/compare/v2.4.128...v2.4.129">v2.4.129</a>).</p>
		</section>
		<section>
			<h3>Timeline</h3>
			<ul>
				<li>2020-05-15: Issue discovered and internally reported</li>
				<li>2020-07-07: Approval to report the vulnerability to the vendor granted</li>
				<li>2020-07-13: <a href="https://github.com/MISP/MISP/commit/bf4610c947c7dc372c4078f363d2dff6ae0703a8">Vendor releases patch</a></li>
				<li>2021-02-07: Advisory published on personal home page</li>
			</ul>
		</section>
		<section>
			<h3>Attachments</h3>
			<ol>
				<li><a id="1">HTTP request and response pair showing successful <i>setHomePage</i> API call:<br>
					<img src="CVE-2020-15711_1.png" alt="HTTP request and response pair showing successful 'setHomePage' API call"></a></li>
				<li><a id="2"><i>Home</i> navigation item with the URL partially controlled by the attacker:<br>
					<img src="CVE-2020-15711_2.png" alt="'Home' navigation item with the URL partially controlled by the attacker"></a></li>
				<li><a id="3">CSRF PoC to exploit the vulnerability:<br>
					<img src="CVE-2020-15711_3.png" alt="CSRF PoC to exploit the vulnerability"></a></li>
			</ol>
		</section>
	</main>
</body>
</html>
